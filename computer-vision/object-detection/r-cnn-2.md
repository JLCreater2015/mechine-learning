# R-CNNåŸç†ï¼ˆäºŒï¼‰

## ğŸ–Œ 3ã€Fast R-CNN

Fast R-CNNæ˜¯ç«¯åˆ°ç«¯ï¼ˆend-to-endï¼‰çš„ã€‚

![&#x56FE;5 Fast R-CNN&#x6A21;&#x578B;](../../.gitbook/assets/image%20%2810%29.png)

å›¾ä¸­çœç•¥äº†é€šè¿‡ `ss` è·å¾—proposalçš„è¿‡ç¨‹ï¼Œç¬¬ä¸€å¼ å›¾ä¸­çº¢æ¡†é‡Œçš„å†…å®¹å³ä¸ºé€šè¿‡`ss`æå–åˆ°çš„proposalï¼Œä¸­é—´çš„ä¸€å—æ˜¯ç»è¿‡æ·±åº¦å·ç§¯ä¹‹åå¾—åˆ°çš„`conv feature map`ï¼Œå›¾ä¸­ç°è‰²çš„éƒ¨åˆ†å°±æ˜¯æˆ‘ä»¬çº¢æ¡†ä¸­çš„proposalå¯¹åº”äº`conv feature map`ä¸­çš„ä½ç½®ï¼Œä¹‹åå¯¹è¿™ä¸ªç‰¹å¾ç»è¿‡`ROI pooling layer`å¤„ç†ï¼Œä¹‹åè¿›è¡Œå…¨è¿æ¥ã€‚åœ¨è¿™é‡Œå¾—åˆ°çš„`ROI feature vector`æœ€ç»ˆè¢«åˆ†äº«ï¼Œä¸€ä¸ªè¿›è¡Œå…¨è¿æ¥ä¹‹åç”¨æ¥åš`softmax`å›å½’ï¼Œç”¨æ¥è¿›è¡Œåˆ†ç±»ï¼Œå¦ä¸€ä¸ªç»è¿‡å…¨è¿æ¥ä¹‹åç”¨æ¥åš`bbox`å›å½’ã€‚

> å¯¹ä¸­é—´çš„`Conv feature map`è¿›è¡Œç‰¹å¾æå–ã€‚æ¯ä¸€ä¸ªåŒºåŸŸç»è¿‡`RoI pooling layer`å’Œ`FC layers`å¾—åˆ°ä¸€ä¸ª â€œå›ºå®šé•¿åº¦â€ çš„feature vectorï¼ˆè¿™é‡Œéœ€è¦æ³¨æ„çš„æ˜¯ï¼Œè¾“å…¥åˆ°åé¢`RoI pooling layer`çš„feature mapæ˜¯åœ¨`Conv feature map`ä¸Šæå–çš„ï¼Œæ•…æ•´ä¸ªç‰¹å¾æå–è¿‡ç¨‹ï¼Œåªè®¡ç®—äº†ä¸€æ¬¡å·ç§¯ã€‚è™½ç„¶åœ¨æœ€å¼€å§‹ä¹Ÿæå–å‡ºäº†å¤§é‡çš„`RoI`ï¼Œä½†ä»–ä»¬è¿˜æ˜¯ä½œä¸ºæ•´ä½“è¾“å…¥è¿›å·ç§¯ç½‘ç»œçš„ï¼Œæœ€å¼€å§‹æå–å‡ºçš„`RoI`åŒºåŸŸåªæ˜¯ä¸ºäº†æœ€åçš„Bounding box å›å½’æ—¶ä½¿ç”¨ï¼Œç”¨æ¥è¾“å‡ºåŸå›¾ä¸­çš„ä½ç½®ï¼‰ã€‚

### ğŸ–‹ 3.1ã€ç‰¹ç‚¹

1. è§„é¿R-CNNä¸­å†—ä½™çš„ç‰¹å¾æå–æ“ä½œï¼Œåªå¯¹æ•´å¼ å›¾åƒå…¨åŒºåŸŸè¿›è¡Œä¸€æ¬¡ç‰¹å¾æå–ï¼ˆ`SPP Net`ï¼‰ï¼›
2. ç”¨`RoI pooling`å±‚å–ä»£æœ€åä¸€å±‚max poolingå±‚ï¼ŒåŒæ—¶å¼•å…¥å»ºè®®æ¡†ä¿¡æ¯ï¼Œæå–ç›¸åº”å»ºè®®æ¡†ç‰¹å¾ï¼›
3. Fast R-CNNç½‘ç»œæœ«å°¾é‡‡ç”¨å¹¶è¡Œçš„ä¸åŒçš„å…¨è¿æ¥å±‚ï¼Œå¯åŒæ—¶è¾“å‡ºåˆ†ç±»ç»“æœå’Œçª—å£å›å½’ç»“æœï¼Œå®ç°äº†end-to-endçš„å¤šä»»åŠ¡è®­ç»ƒã€å»ºè®®æ¡†æå–é™¤å¤–ã€‘ï¼Œä¹Ÿä¸éœ€è¦é¢å¤–çš„ç‰¹å¾å­˜å‚¨ç©ºé—´ã€R-CNNä¸­è¿™éƒ¨åˆ†ç‰¹å¾æ˜¯ä¾›`SVM`å’ŒBounding-box regressionè¿›è¡Œè®­ç»ƒçš„ã€‘ï¼›
4. é‡‡ç”¨`SVD`å¯¹Fast R-CNNç½‘ç»œæœ«å°¾å¹¶è¡Œçš„å…¨è¿æ¥å±‚è¿›è¡Œåˆ†è§£ï¼Œå‡å°‘è®¡ç®—å¤æ‚åº¦ï¼ŒåŠ å¿«æ£€æµ‹é€Ÿåº¦ã€‚

Fast R-CNNæ–¹æ³•è§£å†³äº†R-CNNçš„ä¸‰ä¸ªé—®é¢˜ï¼š

1. R-CNNç½‘ç»œè®­ç»ƒã€æµ‹è¯•é€Ÿåº¦éƒ½å¾ˆæ…¢ï¼šR-CNNç½‘ç»œä¸­ï¼Œä¸€å¼ å›¾ç»ç”±selective searchç®—æ³•æå–çº¦`2k`ä¸ªå»ºè®®æ¡†ã€è¿™`2k`ä¸ªå»ºè®®æ¡†å¤§é‡é‡å ã€‘ï¼Œè€Œæ‰€æœ‰å»ºè®®æ¡†å˜å½¢åéƒ½è¦è¾“å…¥`AlexNet` CNNç½‘ç»œæå–ç‰¹å¾ã€å³çº¦`2k`æ¬¡ç‰¹å¾æå–ã€‘ï¼Œä¼šå‡ºç°ä¸Šè¿°é‡å åŒºåŸŸå¤šæ¬¡é‡å¤æå–ç‰¹å¾ï¼Œæå–ç‰¹å¾æ“ä½œå†—ä½™ï¼›
2. R-CNNç½‘ç»œè®­ç»ƒã€æµ‹è¯•ç¹çï¼šR-CNNç½‘ç»œè®­ç»ƒè¿‡ç¨‹åˆ†ä¸º`ILSVRC 2012`æ ·æœ¬ä¸‹æœ‰ç›‘ç£é¢„è®­ç»ƒã€`PASCAL VOC 2007`è¯¥ç‰¹å®šæ ·æœ¬ä¸‹çš„å¾®è°ƒã€20ç±»å³21ä¸ª`SVM`åˆ†ç±»å™¨è®­ç»ƒå’Œ20ä¸ªBounding-boxå›å½’å™¨è®­ç»ƒï¼Œè¯¥è®­ç»ƒæµç¨‹ç¹çå¤æ‚ï¼Œå¹¶ä¸”éœ€è¦å¤§é‡å­˜å‚¨ç©ºé—´ï¼›
3. R-CNNç½‘ç»œéœ€è¦å¯¹å»ºè®®æ¡†è¿›è¡Œå½¢å˜æ“ä½œåã€å½¢å˜ä¸º227Ã—227 sizeã€‘å†è¾“å…¥CNNç½‘ç»œæå–ç‰¹å¾ï¼Œå…¶å®åƒ`AlexNet`ç­‰ç½‘ç»œåœ¨æå–ç‰¹å¾è¿‡ç¨‹ä¸­å¯¹å›¾åƒçš„å¤§å°å¹¶æ— è¦æ±‚ï¼Œåªæ˜¯åœ¨æå–å®Œç‰¹å¾è¿›è¡Œå…¨è¿æ¥æ“ä½œçš„æ—¶å€™æ‰éœ€è¦å›ºå®šç‰¹å¾å°ºå¯¸ã€R-CNNä¸­å°†è¾“å…¥å›¾åƒå½¢å˜ä¸º227Ã—227å¯æ­£å¥½æ»¡è¶³`AlexNet`ç½‘ç»œæœ€åçš„ç‰¹å¾å°ºå¯¸è¦æ±‚ã€‘ï¼Œç„¶åæ‰ä½¿ç”¨`SVM`åˆ†ç±»å™¨åˆ†ç±»ï¼ŒR-CNNéœ€è¦è¿›è¡Œå½¢å˜æ“ä½œçš„é—®é¢˜åœ¨Fast R-CNNå·²ç»ä¸å­˜åœ¨ã€‚

### ğŸ–‹ 3.2ã€ç½‘ç»œç»“æ„

#### âœ 3.2.1ã€åŸºæœ¬ç½‘ç»œ

å›¾åƒå½’ä¸€åŒ–ä¸º 224Ã—224 åç›´æ¥é€å…¥ç½‘ç»œã€‚å‰äº”é˜¶æ®µæ˜¯åŸºç¡€çš„`conv+relu+pooling`å½¢å¼ï¼Œåœ¨ç¬¬äº”é˜¶æ®µç»“å°¾ï¼Œè¾“å…¥Pä¸ªå€™é€‰åŒºåŸŸï¼ˆå›¾åƒåºå·Ã—1 + å‡ ä½•ä½ç½®Ã—4ï¼Œåºå·ç”¨äºè®­ç»ƒï¼‰ã€‚

![&#x56FE;6 Fast R-CNN&#x6A21;&#x578B;&#x4E2D;&#x7684;Backbone&#x7F51;&#x7EDC;](../../.gitbook/assets/image%20%2819%29.png)

> æ³¨ï¼šæ–‡ä¸­ç»™å‡ºäº†å¤§ä¸­å°ä¸‰ç§ç½‘ç»œï¼Œæ­¤å¤„æ˜¾ç¤ºå‡ºæœ€å¤§çš„ä¸€ç§ã€‚ä¸‰ç§ç½‘ç»œåŸºæœ¬ç»“æ„ç›¸ä¼¼ï¼Œä»…`conv+relu`å±‚æ•°æœ‰å·®åˆ«ï¼Œæˆ–è€…å¢åˆ äº†normå±‚ã€‚

#### âœ 3.2.2ã€[`RoI pooling layer`](roi-pooling.md) 

æ¯ä¸€ä¸ª`RoI`éƒ½æœ‰ä¸€ä¸ªå››å…ƒç»„ $$(r,c,h,w)$$ è¡¨ç¤ºï¼Œå…¶ä¸­ $$(r,c)$$ è¡¨ç¤ºå·¦ä¸Šè§’ï¼Œè€Œ $$(h,w)$$ åˆ™ä»£è¡¨é«˜åº¦å’Œå®½åº¦ã€‚è¿™ä¸€å±‚ä½¿ç”¨æœ€å¤§æ± åŒ–ï¼ˆmax poolingï¼‰æ¥å°†`RoI`åŒºåŸŸè½¬åŒ–æˆå›ºå®šå¤§å°çš„ $$H\times W$$ çš„ç‰¹å¾å›¾ã€‚å‡è®¾ä¸€ä¸ª`RoI`çš„çª—å£å¤§å°ä¸º $$h\times w$$ ï¼Œåˆ™è½¬æ¢æˆ $$H\times W$$ ä¹‹åï¼Œæ¯ä¸€ä¸ªç½‘æ ¼éƒ½æ˜¯ä¸€ä¸ª $$h/H * w/W$$ å¤§å°çš„å­ç½‘ï¼Œåˆ©ç”¨æœ€å¤§æ± åŒ–å°†è¿™ä¸ªå­ç½‘ä¸­çš„å€¼æ˜ å°„åˆ° $$H\times W$$ çª—å£å³å¯ã€‚Poolingå¯¹æ¯ä¸€ä¸ªç‰¹å¾å›¾é€šé“éƒ½æ˜¯ç‹¬ç«‹çš„ï¼Œè¿™æ˜¯`SPP layer`çš„ç‰¹ä¾‹ï¼Œå³åªæœ‰ä¸€å±‚çš„ç©ºé—´é‡‘å­—å¡”ã€‚

#### âœ 3.2.3ã€**åˆ†ç±»å™¨ä¸å›å½’å™¨**

åˆ†ç±»å™¨å’Œå›å½’å™¨çš„è¾“å…¥ä¸º`RoI`æ± åŒ–è¾“å‡ºçš„å›ºå®šå¤§å°å‘é‡ç»è¿‡ä¸¤å±‚å…¨è¿æ¥å±‚åäº§ç”Ÿçš„ç‰¹å¾å‘é‡ï¼Œå±äºå¹¶è”ï¼Œåˆ†ç±»å™¨ç”¨äºåˆ¤æ–­ç‰©å“å±äºå“ªä¸€ç±»ï¼ˆç±»åˆ«+èƒŒæ™¯ï¼‰ï¼Œå›å½’å™¨ç”¨äºè®¡ç®—4ä¸ªè°ƒæ•´å› å­ï¼Œè°ƒæ•´å› å­éƒ¨åˆ†å†…å®¹è§R-CNNç¬”è®°ã€‚

### ğŸ–‹ 3.3ã€æµ‹è¯•è¿‡ç¨‹

![](../../.gitbook/assets/image%20%2816%29.png)

1. ä»»æ„sizeå›¾ç‰‡è¾“å…¥CNNç½‘ç»œï¼Œç»è¿‡è‹¥å¹²å·ç§¯å±‚ä¸æ± åŒ–å±‚ï¼Œå¾—åˆ°ç‰¹å¾å›¾ï¼›
2. åœ¨ä»»æ„sizeå›¾ç‰‡ä¸Šé‡‡ç”¨selective searchç®—æ³•æå–çº¦`2k`ä¸ªå»ºè®®æ¡†ï¼›
3. æ ¹æ®åŸå›¾ä¸­å»ºè®®æ¡†åˆ°ç‰¹å¾å›¾æ˜ å°„å…³ç³»ï¼Œåœ¨ç‰¹å¾å›¾ä¸­æ‰¾åˆ°æ¯ä¸ªå»ºè®®æ¡†å¯¹åº”çš„ç‰¹å¾æ¡†ã€æ·±åº¦å’Œç‰¹å¾å›¾ä¸€è‡´ã€‘ï¼Œå¹¶åœ¨`RoI`æ± åŒ–å±‚ä¸­å°†æ¯ä¸ªç‰¹å¾æ¡†æ± åŒ–åˆ° $$H\times W$$ ã€`VGG-16`ç½‘ç»œæ˜¯`7Ã—7`ã€‘çš„sizeï¼›
4. å›ºå®š $$H\times W$$ã€`VGG-16`ç½‘ç»œæ˜¯`7Ã—7`ã€‘å¤§å°çš„ç‰¹å¾æ¡†ç»è¿‡å…¨è¿æ¥å±‚å¾—åˆ°å›ºå®šå¤§å°çš„ç‰¹å¾å‘é‡ï¼›
5. ç¬¬4æ­¥æ‰€å¾—ç‰¹å¾å‘é‡ç»ç”±å„è‡ªçš„å…¨è¿æ¥å±‚ã€ç”±`SVD`åˆ†è§£å®ç°ã€‘ï¼Œåˆ†åˆ«å¾—åˆ°ä¸¤ä¸ªè¾“å‡ºå‘é‡ï¼šä¸€ä¸ªæ˜¯`softmax`çš„åˆ†ç±»å¾—åˆ†ï¼Œä¸€ä¸ªæ˜¯Bounding-boxçª—å£å›å½’ï¼›
6. åˆ©ç”¨çª—å£å¾—åˆ†åˆ†åˆ«å¯¹æ¯ä¸€ç±»ç‰©ä½“è¿›è¡Œéæå¤§å€¼æŠ‘åˆ¶å‰”é™¤é‡å å»ºè®®æ¡†ï¼Œæœ€ç»ˆå¾—åˆ°æ¯ä¸ªç±»åˆ«ä¸­å›å½’ä¿®æ­£åçš„å¾—åˆ†æœ€é«˜çš„çª—å£ã€‚

#### âœ **3.2.1ã€å…¨è¿æ¥å±‚æé€Ÿ**

**ä¸ºä»€ä¹ˆè¦é‡‡ç”¨`SVD`åˆ†è§£å®ç°Fast R-CNNç½‘ç»œä¸­æœ€åçš„å…¨è¿æ¥å±‚ï¼Ÿå…·ä½“å¦‚ä½•å®ç°ï¼Ÿ**

å›¾åƒåˆ†ç±»ä»»åŠ¡ä¸­ï¼Œç”¨äºå·ç§¯å±‚è®¡ç®—çš„æ—¶é—´æ¯”ç”¨äºå…¨è¿æ¥å±‚è®¡ç®—çš„æ—¶é—´å¤šï¼Œè€Œåœ¨ç›®æ ‡æ£€æµ‹ä»»åŠ¡ä¸­ï¼Œselective searchç®—æ³•æå–çš„å»ºè®®æ¡†æ¯”è¾ƒå¤šï¼Œå‡ ä¹æœ‰ä¸€åŠçš„å‰å‘è®¡ç®—æ—¶é—´è¢«èŠ±è´¹äºå…¨è¿æ¥å±‚ï¼Œå°±Fast R-CNNè€Œè¨€ï¼Œ`RoI`æ± åŒ–å±‚åçš„å…¨è¿æ¥å±‚éœ€è¦è¿›è¡Œçº¦ `2k` æ¬¡ã€æ¯ä¸ªå»ºè®®æ¡†éƒ½è¦è®¡ç®—ã€‘ï¼Œå› æ­¤åœ¨Fast R-CNNä¸­å¯ä»¥é‡‡ç”¨`SVD`åˆ†è§£åŠ é€Ÿå…¨è¿æ¥å±‚è®¡ç®—ï¼›

åˆ†ç±»å’Œä½ç½®è°ƒæ•´éƒ½æ˜¯é€šè¿‡å…¨è¿æ¥å±‚å®ç°çš„ï¼Œè®¾å‰ä¸€çº§æ•°æ®ä¸º x åä¸€çº§ä¸º yï¼Œå…¨è¿æ¥å±‚å‚æ•°ä¸º $$W$$ ï¼Œå°ºå¯¸ $$u\times v$$ ã€‚ä¸€æ¬¡å‰å‘ä¼ æ’­ï¼ˆforwardï¼‰å³ä¸º $$y=Wx$$ ï¼Œè®¡ç®—å¤æ‚åº¦ä¸º$$u\times v$$ ã€‚ å°†Wè¿›è¡Œ`SVD`åˆ†è§£ï¼Œå¹¶ç”¨å‰ $$t$$ ä¸ªç‰¹å¾å€¼è¿‘ä¼¼ï¼š

$$
W=U\sum V^T \approx U(:,1:t)â‹…\sum (1:t,1:t)â‹…V(:,1:t)^T
$$

åŸæ¥çš„å‰å‘ä¼ æ’­åˆ†è§£æˆä¸¤æ­¥ï¼š

$$
y=Wx=Uâ‹…(\sum â‹…V^T)â‹…x=Uâ‹…z
$$

è®¡ç®—å¤æ‚åº¦å˜ä¸º $$uÃ—t+vÃ—t$$ ã€‚ åœ¨å®ç°æ—¶ï¼Œç›¸å½“äºæŠŠä¸€ä¸ªå…¨è¿æ¥å±‚æ‹†åˆ†æˆä¸¤ä¸ªï¼Œä¸­é—´ä»¥ä¸€ä¸ªä½ç»´æ•°æ®ç›¸è¿ã€‚ç¬¬ä¸€ä¸ªå…¨è¿æ¥å±‚ä¸å«åç½®ï¼Œç¬¬äºŒä¸ªå…¨è¿æ¥å±‚å«åç½®ï¼›å®éªŒè¡¨æ˜ï¼Œ`SVD`åˆ†è§£å…¨è¿æ¥å±‚èƒ½ä½¿`mAP`åªä¸‹é™0.3%çš„æƒ…å†µä¸‹æå‡30%çš„é€Ÿåº¦ï¼ŒåŒæ—¶è¯¥æ–¹æ³•ä¹Ÿä¸å¿…å†æ‰§è¡Œé¢å¤–çš„å¾®è°ƒæ“ä½œã€‚

![](../../.gitbook/assets/image%20%2817%29.png)

> åœ¨GitHubçš„æºç ä¸­ï¼Œè¿™éƒ¨åˆ†ä¼¼ä¹æ²¡æœ‰å®ç°ã€‚

### ğŸ–‹ 3.4ã€è®­ç»ƒè¿‡ç¨‹

#### âœ 3.4.1ã€æœ‰ç›‘ç£é¢„è®­ç»ƒ

**3.4.1.1ã€å‚æ•°åˆå§‹åŒ–**

ï¼ˆ1ï¼‰ã€ç½‘ç»œé™¤å»æœ«å°¾éƒ¨åˆ†ï¼ˆå³backboneï¼‰å¦‚å›¾6ï¼Œåœ¨`ImageNet`ä¸Šè®­ç»ƒ 1000 ç±»åˆ†ç±»å™¨ã€‚ç»“æœå‚æ•°ä½œä¸ºç›¸åº”å±‚çš„åˆå§‹åŒ–å‚æ•°ã€‚å…¶ä½™å‚æ•°éšæœºåˆå§‹åŒ–ã€‚

ï¼ˆ2ï¼‰ã€ä»é¢„è®­ç»ƒçš„ç½‘ç»œä¸­åˆå§‹åŒ–æ•°æ® æœ‰ä¸‰ç§é¢„è®­ç»ƒçš„ç½‘ç»œï¼š`CaffeNet`ï¼Œ`VGG_CNN_M_1024`ï¼Œ`VGG-16`ï¼Œä»–ä»¬éƒ½æœ‰5ä¸ªæœ€å¤§æ± åŒ–å±‚å’Œ5åˆ°13ä¸ªä¸ç­‰çš„å·ç§¯å±‚ã€‚ç”¨ä»–ä»¬æ¥åˆå§‹åŒ–Fast R-CNNæ—¶ï¼Œéœ€è¦ä¿®æ”¹ä¸‰å¤„ï¼š

* â‘ æœ€åä¸€ä¸ªæ± åŒ–å±‚è¢«`RoI pooling layer`å–ä»£ï¼›
* â‘¡æœ€åä¸€ä¸ªå…¨è¿æ¥å±‚å’Œ`softmax`è¢«æ›¿æ¢æˆä¹‹å‰ä»‹ç»è¿‡çš„ä¸¤ä¸ªå…„å¼Ÿå¹¶åˆ—å±‚ï¼›
* â‘¢ç½‘ç»œè¾“å…¥ä¸¤ç»„æ•°æ®ï¼šä¸€ç»„å›¾ç‰‡å’Œé‚£äº›å›¾ç‰‡çš„ä¸€ç»„`RoIs`ã€‚

**3.4.1.2ã€åˆ†ç±»ä¸ä½ç½®è°ƒæ•´**

ç¬¬äº”é˜¶æ®µçš„ç‰¹å¾è¾“å…¥åˆ°ä¸¤ä¸ªå¹¶è¡Œçš„å…¨è¿å±‚ä¸­ï¼ˆç§°ä¸ºmulti-taskï¼‰ã€‚

![&#x56FE;7 Fast R-CNN&#x4E2D;&#x7684;&#x5206;&#x7C7B;&#x548C;&#x4F4D;&#x7F6E;&#x56DE;&#x5F52;&#x7F51;&#x7EDC;](../../.gitbook/assets/image%20%2820%29.png)

> `cls_score`å±‚ç”¨äºåˆ†ç±»ï¼Œè¾“å‡º $$K+1$$ ç»´æ•°ç»„pï¼Œè¡¨ç¤ºå±äº K ç±»å’ŒèƒŒæ™¯çš„æ¦‚ç‡ã€‚ `bbox_prdict`å±‚ç”¨äºè°ƒæ•´å€™é€‰åŒºåŸŸä½ç½®ï¼Œè¾“å‡º $$4\times K$$ ç»´æ•°ç»„ tï¼Œè¡¨ç¤ºåˆ†åˆ«å±äº K ç±»æ—¶ï¼Œåº”è¯¥å¹³ç§»ç¼©æ”¾çš„å‚æ•°ã€‚

#### âœ 3.4.2ã€ç‰¹å®šæ ·æœ¬ä¸‹çš„å¾®è°ƒ

ä½¿ç”¨BPç®—æ³•è®­ç»ƒç½‘ç»œæ˜¯Fast R-CNNçš„é‡è¦èƒ½åŠ›ï¼Œ`SPP-net`ä¸èƒ½å¾®è°ƒ`SPP`å±‚ä¹‹å‰çš„å±‚ï¼Œä¸»è¦æ˜¯å› ä¸ºå½“æ¯ä¸€ä¸ªè®­ç»ƒæ ·æœ¬æ¥è‡ªäºä¸åŒçš„å›¾ç‰‡æ—¶ï¼Œç»è¿‡`SPP`å±‚çš„BPç®—æ³•æ˜¯å¾ˆä½æ•ˆçš„ï¼ˆæ„Ÿå—é‡å¤ªå¤§ï¼‰ã€‚

Fast R-CNNæå‡º`SGD mini_batch`åˆ†å±‚å–æ ·çš„æ–¹æ³•ï¼šé¦–å…ˆéšæœºå–æ ·`N`å¼ å›¾ç‰‡ï¼Œç„¶åæ¯å¼ å›¾ç‰‡å–æ ·`R/N`ä¸ª`RoIs e.g. N=2 and R=128`ï¼Œ é™¤äº†åˆ†å±‚å–æ ·ï¼Œè¿˜æœ‰ä¸€ä¸ªå°±æ˜¯Fast R-CNNåœ¨ä¸€æ¬¡å¾®è°ƒä¸­è”åˆä¼˜åŒ–`softmax`åˆ†ç±»å™¨å’Œ`bbox`å›å½’ï¼Œçœ‹ä¼¼ä¸€æ­¥ï¼Œå®é™…åŒ…å«äº†å¤šä»»åŠ¡æŸå¤±ï¼ˆmulti-task lossï¼‰ã€å°æ‰¹é‡å–æ ·ï¼ˆmini-batch samplingï¼‰ã€`RoI pooling`å±‚çš„åå‘ä¼ æ’­ï¼ˆ`backpropagation through RoI pooling layers`ï¼‰ã€`SGD`è¶…å‚æ•°ï¼ˆ`SGD hyperparameters`ï¼‰ã€‚

**3.4.2.1ã€åˆ†å±‚æ•°æ®**

åœ¨è°ƒä¼˜è®­ç»ƒæ—¶ï¼Œæ¯ä¸€ä¸ªmini-batchä¸­é¦–å…ˆåŠ å…¥Nå¼ å®Œæ•´å›¾ç‰‡ï¼Œè€ŒååŠ å…¥ä» N å¼ å›¾ç‰‡ä¸­é€‰å–çš„ R ä¸ªå€™é€‰æ¡†ã€‚è¿™ R ä¸ªå€™é€‰æ¡†å¯ä»¥å¤ç”¨ N å¼ å›¾ç‰‡å‰5ä¸ªé˜¶æ®µçš„ç½‘ç»œç‰¹å¾ã€‚

> å®é™…é€‰æ‹©N=2ï¼Œ R=128ã€‚

**3.4.2.2ã€è®­ç»ƒæ•°æ®æ„æˆ**

Nå¼ å®Œæ•´å›¾ç‰‡ä»¥50%æ¦‚ç‡æ°´å¹³ç¿»è½¬ã€‚ Rä¸ªå€™é€‰æ¡†çš„æ„æˆæ–¹å¼å¦‚ä¸‹ï¼š

| ç±»åˆ« | æ¯”ä¾‹ | æ–¹å¼ |
| :--- | :--- | :--- |
| å‰æ™¯ | 25% | ä¸æŸä¸ªçœŸå€¼é‡å åœ¨ \[0.5,1\] çš„å€™é€‰æ¡† |
| èƒŒæ™¯ | 75% | ä¸çœŸå€¼é‡å çš„æœ€å¤§å€¼åœ¨ \[0.1,0.5\) çš„å€™é€‰æ¡† |

#### \*\*\*\*âœ 3.4.3ã€**ä»£ä»·å‡½æ•°** **ï¼ˆMulti-task lossï¼‰**

![](../../.gitbook/assets/image%20%2839%29.png)

* $$p$$ æ˜¯åˆ†ç±»å™¨é¢„æµ‹çš„ ****`softmax` æ¦‚ç‡åˆ†å¸ƒ $$p=(p_0,\ldots,p_k)$$ ï¼›
* $$u$$ å¯¹åº”ç›®æ ‡çœŸå®ç±»åˆ«æ ‡ç­¾ï¼›
* $$t^u$$ å¯¹åº”è¾¹ç•Œæ¡†å›å½’å™¨é¢„æµ‹çš„å¯¹åº”ç±»åˆ« $$u$$ çš„å›å½’å‚æ•° $$(t_x^u, t_y^u, t_w^u, t_h^u)$$ ï¼›
* $$v$$ å¯¹åº”çœŸå®ç›®æ ‡çš„è¾¹ç•Œæ¡†å›å½’å‚æ•° $$(v_x, v_y, v_w, v_h)$$ ï¼›
* $$[u\ge 1]$$ æ˜¯è‰¾å¼—æ£®æ‹¬å·ã€‚

`loss_cls`å±‚è¯„ä¼°åˆ†ç±»ä»£ä»·ã€‚ç”±çœŸå®åˆ†ç±» $$u$$ å¯¹åº”çš„æ¦‚ç‡å†³å®šï¼š

$$
L_{cls} = âˆ’log\ p_u
$$

`loss_bbox`è¯„ä¼°æ£€æµ‹æ¡†å®šä½ä»£ä»·ã€‚æ¯”è¾ƒçœŸå®åˆ†ç±»å¯¹åº”çš„é¢„æµ‹å‚æ•° $$t^u$$ å’ŒçœŸå®å¹³ç§»ç¼©æ”¾å‚æ•°ä¸º $$v$$ çš„å·®åˆ«ï¼š

$$
L_{loc}=\sum\limits_{i\in\{x,y,w,h\}} smooth_{L_1}(t^u_iâˆ’v_i)
$$

$$smooth_{L_1}$$ ä¸º`Smooth L1`è¯¯å·®ï¼Œå¯¹outlierä¸æ•æ„Ÿï¼š

$$
smooth_{L_1}(x)= \begin{cases}0.5x^2 & |x|<1 \\
|x|âˆ’0.5 & otherwise \end{cases}
$$

æ€»ä»£ä»·ä¸ºä¸¤è€…åŠ æƒå’Œï¼Œå¦‚æœåˆ†ç±»ä¸ºèƒŒæ™¯åˆ™ä¸è€ƒè™‘å®šä½ä»£ä»·ï¼š

$$
L= \begin{cases} L_{cls}+Î»L_{loc} & u\text{ä¸ºå‰æ™¯} \\
L_{cls} & u\text{ä¸ºèƒŒæ™¯} \end{cases}
$$

> æºç ä¸­`bbox_loss_weights`ç”¨äºæ ‡è®°æ¯ä¸€ä¸ª`bbox`æ˜¯å¦å±äºæŸä¸€ä¸ªç±»ã€‚

## ğŸ–Œ 4ã€Faster R-CNN

ç»è¿‡R-CNNå’ŒFast R-CNNçš„ç§¯æ·€ï¼Œ`Ross B. Girshick`åœ¨2016å¹´æå‡ºäº†æ–°çš„Faster R-CNNï¼Œåœ¨ç»“æ„ä¸Šï¼ŒFaster R-CNNå·²ç»å°†ç‰¹å¾æŠ½å–ï¼Œproposalæå–ï¼Œbounding box regressionå’Œclassificationéƒ½æ•´åˆåœ¨äº†ä¸€ä¸ªç½‘ç»œä¸­ï¼Œä½¿å¾—ç»¼åˆæ€§èƒ½æœ‰è¾ƒå¤§æé«˜ï¼Œåœ¨æ£€æµ‹é€Ÿåº¦æ–¹é¢å°¤ä¸ºæ˜æ˜¾ã€‚

![&#x56FE;8 Faster R-CNN&#x57FA;&#x672C;&#x7ED3;&#x6784;&#xFF08;&#x6765;&#x81EA;&#x539F;&#x8BBA;&#x6587;&#xFF09;](../../.gitbook/assets/image%20%2818%29.png)

å¦‚å›¾ï¼ŒFaster R-CNNå…¶å®å¯ä»¥åˆ†ä¸º4ä¸ªä¸»è¦å†…å®¹ï¼š

1. `Conv layers`ã€‚ä½œä¸ºä¸€ç§CNNç½‘ç»œç›®æ ‡æ£€æµ‹æ–¹æ³•ï¼ŒFaster R-CNNé¦–å…ˆä½¿ç”¨ä¸€ç»„åŸºç¡€çš„`conv+relu+pooling`å±‚æå–imageçš„feature mapsã€‚è¯¥feature mapsè¢«å…±äº«ç”¨äºåç»­`RPN`å±‚å’Œå…¨è¿æ¥å±‚ã€‚
2. `Region Proposal Networks`ã€‚`RPN`ç½‘ç»œç”¨äºç”Ÿæˆregion proposalsã€‚è¯¥å±‚é€šè¿‡`softmax`åˆ¤æ–­anchorså±äºpositiveæˆ–è€…negativeï¼Œå†åˆ©ç”¨bounding box regressionä¿®æ­£anchorsè·å¾—ç²¾ç¡®çš„proposalsã€‚ï¼ˆanchorä¸proposalçš„åŒºåˆ«ï¼‰
3. `Roi Pooling`ã€‚è¯¥å±‚æ”¶é›†è¾“å…¥çš„feature mapså’Œproposalsï¼Œç»¼åˆè¿™äº›ä¿¡æ¯åæå–proposal feature mapsï¼Œé€å…¥åç»­å…¨è¿æ¥å±‚åˆ¤å®šç›®æ ‡ç±»åˆ«ã€‚
4. `Classification and Bounding Box Regression`ã€‚åˆ©ç”¨proposal feature mapsè®¡ç®—proposalçš„ç±»åˆ«ï¼Œ**åŒæ—¶å†æ¬¡bounding box regressionè·å¾—æ£€æµ‹æ¡†æœ€ç»ˆçš„ç²¾ç¡®ä½ç½®**ã€‚

![&#x56FE;9 faster\_rcnn\_test.pt&#x7F51;&#x7EDC;&#x7ED3;&#x6784; &#xFF08;pascal\_voc/VGG16/faster\_rcnn\_alt\_opt/faster\_rcnn\_test.pt&#xFF09;](../../.gitbook/assets/image%20%2827%29.png)

å›¾9å±•ç¤ºäº†pythonç‰ˆæœ¬ä¸­çš„`VGG16`æ¨¡å‹ä¸­çš„`faster_rcnn_test.pt`çš„ç½‘ç»œç»“æ„ï¼Œå¯ä»¥æ¸…æ™°çš„çœ‹åˆ°è¯¥ç½‘ç»œå¯¹äºä¸€å‰¯ä»»æ„å¤§å° $$P\times Q$$ çš„å›¾åƒï¼Œé¦–å…ˆç¼©æ”¾è‡³å›ºå®šå¤§å° $$M\times N$$ ï¼Œç„¶åå°† $$M\times N$$ å›¾åƒé€å…¥ç½‘ç»œï¼›è€Œ`Conv layers`ä¸­åŒ…å«äº† `13ä¸ªconvå±‚+13 ä¸ªreluå±‚+4ä¸ªpoolingå±‚`ï¼›`RPN`ç½‘ç»œé¦–å…ˆç»è¿‡ `3x3` å·ç§¯ï¼Œå†åˆ†åˆ«ç”Ÿæˆpositive anchorså’Œå¯¹åº”bounding box regressionåç§»é‡ï¼Œç„¶åè®¡ç®—å‡º`proposals`ï¼›è€Œ`Roi Pooling`å±‚åˆ™åˆ©ç”¨`proposals`ä»`feature maps`ä¸­æå–`proposal feature`é€å…¥åç»­å…¨è¿æ¥å’Œ`softmax`ç½‘ç»œä½œ`classification`ï¼ˆå³åˆ†ç±»proposalåˆ°åº•æ˜¯ä»€ä¹ˆobjectï¼‰ã€‚

### ğŸ–‹ 4.1ã€`Conv layers`

`Conv layers`åŒ…å«äº†`conv`ï¼Œpoolingï¼Œ`relu`ä¸‰ç§å±‚ã€‚ä»¥pythonç‰ˆæœ¬ä¸­çš„`VGG16`æ¨¡å‹ä¸­çš„`faster_rcnn_test.pt`çš„ç½‘ç»œç»“æ„ä¸ºä¾‹ï¼Œå¦‚å›¾9ï¼Œ`Conv layers`éƒ¨åˆ†å…±æœ‰13ä¸ª`conv`å±‚ï¼Œ13ä¸ª`relu`å±‚ï¼Œ4ä¸ªpoolingå±‚ã€‚è¿™é‡Œæœ‰ä¸€ä¸ªéå¸¸å®¹æ˜“è¢«å¿½ç•¥ä½†æ˜¯åˆæ— æ¯”é‡è¦çš„ä¿¡æ¯ï¼Œåœ¨`Conv layers`ä¸­ï¼š

1. æ‰€æœ‰çš„`conv`å±‚éƒ½æ˜¯ï¼škernel\_size=3ï¼Œpad=1ï¼Œstride=1ï¼›
2. æ‰€æœ‰çš„poolingå±‚éƒ½æ˜¯ï¼škernel\_size=2ï¼Œpad=1ï¼Œstride=1ã€‚

ä¸ºä½•é‡è¦ï¼Ÿåœ¨`Faster R-CNN Conv layers`ä¸­å¯¹æ‰€æœ‰çš„å·ç§¯éƒ½åšäº†æ‰©è¾¹å¤„ç†ï¼ˆ `pad=1`ï¼Œå³å¡«å……ä¸€åœˆ0ï¼‰ï¼Œå¯¼è‡´åŸå›¾å˜ä¸º $$(M+2)\times(N+2)$$ å¤§å°ï¼Œå†åš $$3\times 3$$ å·ç§¯åè¾“å‡º$$M\times N$$ ã€‚æ­£æ˜¯è¿™ç§è®¾ç½®ï¼Œå¯¼è‡´`Conv layers`ä¸­çš„`conv`å±‚ä¸æ”¹å˜è¾“å…¥å’Œè¾“å‡ºçŸ©é˜µå¤§å°ã€‚å¦‚å›¾ï¼š

![](../../.gitbook/assets/image%20%2815%29.png)

ç±»ä¼¼çš„æ˜¯ï¼Œ`Conv layers`ä¸­çš„poolingå±‚`kernel_size=2`ï¼Œ`stride=2`ã€‚è¿™æ ·æ¯ä¸ªç»è¿‡poolingå±‚çš„ $$M\times N$$ çŸ©é˜µï¼Œéƒ½ä¼šå˜ä¸º $$(M/2)\times (N/2)$$ å¤§å°ã€‚ç»¼ä¸Šæ‰€è¿°ï¼Œåœ¨æ•´ä¸ª`Conv layers`ä¸­ï¼Œ`conv`å’Œ`relu`å±‚ä¸æ”¹å˜è¾“å…¥è¾“å‡ºå¤§å°ï¼Œåªæœ‰poolingå±‚ä½¿è¾“å‡ºé•¿å®½éƒ½å˜ä¸ºè¾“å…¥çš„ $$1/2$$ ã€‚é‚£ä¹ˆï¼Œä¸€ä¸ª$$M\times N$$å¤§å°çš„çŸ©é˜µç»è¿‡`Conv layers`å›ºå®šå˜ä¸º$$(M/16)\times (N/16)$$ ã€‚è¿™æ ·`Conv layers`ç”Ÿæˆçš„feature mapä¸­éƒ½å¯ä»¥å’ŒåŸå›¾å¯¹åº”èµ·æ¥ã€‚

### ğŸ–‹ 4.2ã€`Region Proposal Networks(RPN)`

ç»å…¸çš„æ£€æµ‹æ–¹æ³•ç”Ÿæˆæ£€æµ‹æ¡†éƒ½éå¸¸è€—æ—¶ï¼Œå¦‚`OpenCV adaboost`ä½¿ç”¨**æ»‘åŠ¨çª—å£+å›¾åƒé‡‘å­—å¡”**ç”Ÿæˆæ£€æµ‹æ¡†ï¼›æˆ–å¦‚R-CNNä½¿ç”¨`SS(Selective Search)`æ–¹æ³•ç”Ÿæˆæ£€æµ‹æ¡†ã€‚è€Œ`Faster RCNN`åˆ™æŠ›å¼ƒäº†ä¼ ç»Ÿçš„æ»‘åŠ¨çª—å£å’ŒSSæ–¹æ³•ï¼Œç›´æ¥ä½¿ç”¨`RPN`ç”Ÿæˆæ£€æµ‹æ¡†ï¼Œè¿™ä¹Ÿæ˜¯Faster R-CNNçš„å·¨å¤§ä¼˜åŠ¿ï¼Œèƒ½æå¤§æå‡æ£€æµ‹æ¡†çš„ç”Ÿæˆé€Ÿåº¦ã€‚

![&#x56FE;10 RPN&#x7F51;&#x7EDC;&#x7ED3;&#x6784;](../../.gitbook/assets/image%20%2824%29.png)

#### âœ 4.2.1ã€anchors

æ‰€è°“anchorsï¼Œå®é™…ä¸Šå°±æ˜¯ä¸€ç»„ç”±`rpn/generate_anchors.py`ç”Ÿæˆçš„çŸ©å½¢ã€‚ç›´æ¥è¿è¡Œä½œè€…demoä¸­çš„`generate_anchors.py`å¯ä»¥å¾—åˆ°ä»¥ä¸‹è¾“å‡ºï¼š

```text
[[ -84.  -40.   99.   55.]
 [-176.  -88.  191.  103.]
 [-360. -184.  375.  199.]
 [ -56.  -56.   71.   71.]
 [-120. -120.  135.  135.]
 [-248. -248.  263.  263.]
 [ -36.  -80.   51.   95.]
 [ -80. -168.   95.  183.]
 [-168. -344.  183.  359.]]
```

å…¶ä¸­æ¯è¡Œçš„4ä¸ªå€¼ $$(x_1,y_1,x_2,y_2)$$ è¡¨çŸ©å½¢å·¦ä¸Šå’Œå³ä¸‹è§’ç‚¹åæ ‡ã€‚9ä¸ªçŸ©å½¢å…±æœ‰3ç§å½¢çŠ¶ï¼Œé•¿å®½æ¯”ä¸ºå¤§çº¦ä¸º $$width:height\in \{1:1,1:2,2:1\}$$ ä¸‰ç§ï¼Œå¦‚å›¾11ã€‚å®é™…ä¸Šé€šè¿‡anchorså°±å¼•å…¥äº†æ£€æµ‹ä¸­å¸¸ç”¨åˆ°çš„å¤šå°ºåº¦æ–¹æ³•ã€‚

![&#x56FE;11 anchors](../../.gitbook/assets/image%20%2825%29.png)

é‚£ä¹ˆè¿™9ä¸ªanchorsæ˜¯åšä»€ä¹ˆçš„å‘¢ï¼Ÿå€Ÿç”¨Faster R-CNNè®ºæ–‡ä¸­çš„åŸå›¾ï¼Œå¦‚å›¾12ï¼Œéå†`Conv layers`è®¡ç®—è·å¾—çš„feature mapsï¼Œä¸ºæ¯ä¸€ä¸ªç‚¹éƒ½é…å¤‡è¿™9ç§anchorsä½œä¸ºåˆå§‹çš„æ£€æµ‹æ¡†ã€‚è¿™æ ·åšè·å¾—æ£€æµ‹æ¡†å¾ˆä¸å‡†ç¡®ï¼Œä¸ç”¨æ‹…å¿ƒï¼Œ**åé¢è¿˜æœ‰2æ¬¡bounding box regressionå¯ä»¥ä¿®æ­£æ£€æµ‹æ¡†ä½ç½®**ã€‚

![&#x56FE;12](../../.gitbook/assets/image%20%2822%29.png)

è§£é‡Šä¸€ä¸‹ä¸Šé¢è¿™å¼ å›¾çš„æ•°å­—ã€‚

1. åœ¨åŸæ–‡ä¸­ä½¿ç”¨çš„æ˜¯`ZF model`ä¸­ï¼Œå…¶`Conv Layers`ä¸­æœ€åçš„`conv5`å±‚`num_output=256`ï¼Œå¯¹åº”ç”Ÿæˆ256å¼ ç‰¹å¾å›¾ï¼Œæ‰€ä»¥ç›¸å½“äºfeature mapæ¯ä¸ªç‚¹éƒ½æ˜¯256-dimensionsï¼›
2. åœ¨`conv5`ä¹‹åï¼Œåšäº†`rpn_conv/3x3`å·ç§¯ä¸”`num_output=256`ï¼Œç›¸å½“äºæ¯ä¸ªç‚¹åˆèåˆäº†å‘¨å›´ $$3\times 3$$ çš„ç©ºé—´ä¿¡æ¯ï¼ŒåŒæ—¶`256-d`ä¸å˜ï¼ˆå¦‚å›¾11ä¸­çš„çº¢æ¡†ï¼‰ï¼›
3. å‡è®¾åœ¨`conv5 feature map`ä¸­æ¯ä¸ªç‚¹ä¸Šæœ‰kä¸ªanchorï¼ˆé»˜è®¤k=9ï¼‰ï¼Œè€Œæ¯ä¸ª`anhcor`è¦åˆ†positiveå’Œnegativeï¼Œæ‰€ä»¥æ¯ä¸ªç‚¹ç”±`256-d feature`è½¬åŒ–ä¸º`cls=2k scores`ï¼›è€Œæ¯ä¸ªanchoréƒ½æœ‰`(x, y, w, h)`å¯¹åº”4ä¸ªåç§»é‡ï¼Œæ‰€ä»¥`reg=4k coordinates`ï¼›
4. è¡¥å……ä¸€ç‚¹ï¼Œå…¨éƒ¨anchorsæ‹¿å»è®­ç»ƒå¤ªå¤šäº†ï¼Œè®­ç»ƒç¨‹åºä¼šåœ¨åˆé€‚çš„anchorsä¸­éšæœºé€‰å–128ä¸ª`postive anchors`å’Œ128ä¸ª`negative anchors`è¿›è¡Œè®­ç»ƒã€‚

**å…¶å®`RPN`æœ€ç»ˆå°±æ˜¯åœ¨åŸå›¾å°ºåº¦ä¸Šï¼Œè®¾ç½®äº†å¯†å¯†éº»éº»çš„å€™é€‰anchorã€‚ç„¶åç”¨CNNå»åˆ¤æ–­å“ªäº›anchoræ˜¯é‡Œé¢æœ‰ç›®æ ‡çš„positive anchorï¼Œå“ªäº›æ˜¯æ²¡ç›®æ ‡çš„negative anchorã€‚æ‰€ä»¥ï¼Œä»…ä»…æ˜¯ä¸ªäºŒåˆ†ç±»è€Œå·²ï¼**

é‚£ä¹ˆanchorä¸€å…±æœ‰å¤šå°‘ä¸ªï¼ŸåŸå›¾`800x600`ï¼Œ`VGG`ä¸‹é‡‡æ ·16å€ï¼Œfeature mapæ¯ä¸ªç‚¹è®¾ç½®9ä¸ªAnchorï¼Œæ‰€ä»¥ï¼š

$$
ceil(800/16)\times ceil(600/16) \times 9 = 50 \times 38 \times 9 = 17100
$$

å…¶ä¸­`ceil()`è¡¨ç¤ºå‘ä¸Šå–æ•´ï¼Œæ˜¯å› ä¸º`VGG`è¾“å‡ºçš„`feature map size= 50*38`ã€‚**å¿½ç•¥è·¨è¶Šè¾¹ç•Œçš„anchorä»¥åï¼Œå‰©ä¸‹çº¦`6k`ä¸ªã€‚å¯¹äº`RPN`ç”Ÿæˆçš„å€™é€‰æ¡†ä¹‹é—´å­˜åœ¨å¤§é‡é‡å ï¼ŒåŸºäºå€™é€‰æ¡†çš„`cls`å¾—åˆ†ï¼Œé‡‡ç”¨éæå¤§å€¼æŠ‘åˆ¶ï¼Œ`IoU`è®¾ä¸º0.7ï¼Œè¿™æ ·æ¯å¼ å›¾ç‰‡åªå‰©ä¸‹`2k`ä¸ªå€™é€‰æ¡†**ã€‚

**1ã€ä¸ºä»€ä¹ˆanchoråæ ‡ä¸­æœ‰è´Ÿæ•°?**

å›é¡¾anchorç”Ÿæˆæ­¥éª¤ï¼šé¦–å…ˆç”Ÿæˆ 9 ä¸ªbase anchorï¼Œç„¶åé€šè¿‡åæ ‡åç§»åœ¨ `50*38` å¤§å°çš„ $$\frac{1}{16}$$ ä¸‹é‡‡æ ·Feature Mapæ¯ä¸ªç‚¹éƒ½æ”¾ä¸Šè¿™ 9 ä¸ªbase anchorï¼Œå°±å½¢æˆäº† $$50*38*k$$ ä¸ªanchorsã€‚è‡³äºè¿™ 9 ä¸ªbase anchoråæ ‡æ˜¯ä»€ä¹ˆå…¶å®å¹¶ä¸é‡è¦ï¼Œä¸åŒä»£ç å®ç°ä¹Ÿè®¸ä¸åŒã€‚

æ˜¾ç„¶è¿™é‡Œé¢æœ‰ä¸€éƒ¨åˆ†è¾¹ç¼˜anchorsä¼šè¶…å‡ºå›¾åƒè¾¹ç•Œï¼Œè€ŒçœŸå®ä¸­ä¸ä¼šæœ‰è¶…å‡ºå›¾åƒçš„ç›®æ ‡ï¼Œæ‰€ä»¥ä¼šæœ‰clip anchoræ­¥éª¤ã€‚

![](../../.gitbook/assets/image%20%2826%29.png)

**2ã€anchoråˆ°åº•ä¸ç½‘ç»œè¾“å‡ºå¦‚ä½•å¯¹åº”?**

`VGG`è¾“å‡º $$50*38*512$$ çš„ç‰¹å¾ï¼Œå¯¹åº”è®¾ç½® $$50*38*k$$ ä¸ªanchorsï¼Œè€Œ`RPN`è¾“å‡º $$50*38*2k$$ çš„åˆ†ç±»ç‰¹å¾çŸ©é˜µå’Œ $$50*38*4k$$ çš„åæ ‡å›å½’ç‰¹å¾çŸ©é˜µã€‚

![](../../.gitbook/assets/image%20%2823%29.png)

å…¶å®åœ¨å®ç°è¿‡ç¨‹ä¸­ï¼Œæ¯ä¸ªç‚¹çš„ `2k` ä¸ªåˆ†ç±»ç‰¹å¾ä¸ `4k` å›å½’ç‰¹å¾ï¼Œä¸ `k` ä¸ªanchoré€ä¸ªå¯¹åº”å³å¯ï¼Œè¿™å®é™…æ˜¯ä¸€ç§â€œäººä¸ºè®¾ç½®çš„é€»è¾‘æ˜ å°„â€ã€‚å½“ç„¶ï¼Œä¹Ÿå¯ä»¥ä¸è¿™æ ·è®¾ç½®ï¼Œä½†æ˜¯æ— è®ºå¦‚ä½•éƒ½éœ€è¦ä¿è¯åœ¨è®­ç»ƒå’Œæµ‹è¯•è¿‡ç¨‹ä¸­æ˜ å°„æ–¹å¼å¿…é¡»ä¸€è‡´ã€‚

#### âœ 4.2.2ã€**`softmax`åˆ¤å®špositiveä¸negative**

ä¸€å‰¯ $$M\times N$$ å¤§å°çš„çŸ©é˜µé€å…¥Faster R**-**CNNç½‘ç»œåï¼Œåˆ°`RPN`ç½‘ç»œå˜ä¸º $$(M/16)\times (N/16)$$ ï¼Œä¸å¦¨è®¾ $$W=M/16$$ ï¼Œ $$H=N/16$$ ã€‚åœ¨è¿›å…¥reshapeä¸`softmax`ä¹‹å‰ï¼Œå…ˆåšäº† $$1\times 1$$ å·ç§¯ï¼Œè¯¥$$1\times 1$$ å·ç§¯çš„`caffe prototxt`å®šä¹‰å¦‚ä¸‹ï¼š

```python
layer {
  name: "rpn_cls_score"
  type: "Convolution"
  bottom: "rpn/output"
  top: "rpn_cls_score"
  convolution_param {
    num_output: 18   # 2(positive/negative) * 9(anchors)
    kernel_size: 1 pad: 0 stride: 1
  }
}
```

å¯ä»¥çœ‹åˆ°å…¶`num_output=18`ï¼Œä¹Ÿå°±æ˜¯ç»è¿‡è¯¥å·ç§¯çš„è¾“å‡ºå›¾åƒä¸º $$W\times H\times 18$$ å¤§å°ã€‚è¿™ä¹Ÿå°±åˆšå¥½å¯¹åº”äº†feature mapsæ¯ä¸€ä¸ªç‚¹éƒ½æœ‰9ä¸ªanchorsï¼ŒåŒæ—¶æ¯ä¸ªanchorsåˆæœ‰å¯èƒ½æ˜¯positiveå’Œnegativeï¼Œæ‰€æœ‰è¿™äº›ä¿¡æ¯éƒ½ä¿å­˜ $$W\times H\times (9\times2)$$ å¤§å°çš„çŸ©é˜µã€‚åé¢æ¥`softmax`åˆ†ç±»è·å¾—positive anchorsï¼Œä¹Ÿå°±ç›¸å½“äºåˆæ­¥æå–äº†æ£€æµ‹ç›®æ ‡å€™é€‰åŒºåŸŸ`box`ï¼ˆä¸€èˆ¬è®¤ä¸ºç›®æ ‡åœ¨positive anchorsä¸­ï¼‰ã€‚

é‚£ä¹ˆä¸ºä½•è¦åœ¨`softmax`å‰åéƒ½æ¥ä¸€ä¸ªreshape layerï¼Ÿå…¶å®åªæ˜¯ä¸ºäº†ä¾¿äº`softmax`åˆ†ç±»ï¼Œè‡³äºå…·ä½“åŸå› è¿™å°±è¦ä»`caffe`çš„å®ç°å½¢å¼è¯´èµ·äº†ã€‚åœ¨`caffe`åŸºæœ¬æ•°æ®ç»“æ„blobä¸­ä»¥å¦‚ä¸‹å½¢å¼ä¿å­˜æ•°æ®ï¼š

```text
blob=[batch_size, channel, height, width]
```

å¯¹åº”è‡³ä¸Šé¢çš„ä¿å­˜`positive/negative anchors`çš„çŸ©é˜µï¼Œå…¶åœ¨`caffe blob`ä¸­çš„å­˜å‚¨å½¢å¼ä¸º $$ [1, 2\times 9, H, W]$$ ã€‚è€Œåœ¨`softmax`åˆ†ç±»æ—¶éœ€è¦è¿›è¡Œ`positive/negative`äºŒåˆ†ç±»ï¼Œæ‰€ä»¥reshape layerä¼šå°†å…¶å˜ä¸º $$[1, 2, 9\times H, W]$$ å¤§å°ï¼Œå³å•ç‹¬â€œè…¾ç©ºâ€å‡ºæ¥ä¸€ä¸ªç»´åº¦ä»¥ä¾¿`softmax`åˆ†ç±»ï¼Œä¹‹åå†reshapeå›å¤åŸçŠ¶ã€‚è´´ä¸€æ®µ`caffe softmax_loss_layer.cpp`çš„reshapeå‡½æ•°çš„è§£é‡Šï¼Œéå¸¸ç²¾è¾Ÿï¼š

```text
"Number of labels must match number of predictions; "
"e.g., if softmax axis == 1 and prediction shape is (N, C, H, W), "
"label count (number of labels) must be N*H*W, "
"with integer values in {0, 1, ..., C-1}.";
```

ç»¼ä¸Šæ‰€è¿°ï¼Œ`RPN`ç½‘ç»œä¸­åˆ©ç”¨`softmax`åˆæ­¥æå–å‡ºpositive anchorsä½œä¸ºå€™é€‰åŒºåŸŸï¼ˆå¦å¤–ä¹Ÿæœ‰å®ç°ç”¨`sigmoid`ä»£æ›¿`softmax`ï¼ŒåŸç†ç±»ä¼¼ï¼‰ã€‚

#### âœ 4.2.3ã€**å¯¹proposalsè¿›è¡Œbounding box regression**

è¿™é‡Œçš„$$1\times 1$$ å·ç§¯çš„`caffe prototxt`å®šä¹‰ï¼š

```python
layer {
  name: "rpn_bbox_pred"
  type: "Convolution"
  bottom: "rpn/output"
  top: "rpn_bbox_pred"
  convolution_param {
    num_output: 36   # 4 * 9(anchors)
    kernel_size: 1 pad: 0 stride: 1
  }
}
```

å¯ä»¥çœ‹åˆ°å…¶ `num_output=36`ï¼Œå³ç»è¿‡è¯¥å·ç§¯è¾“å‡ºå›¾åƒä¸º $$W\times H\times 36$$ ï¼Œåœ¨`caffe blob`å­˜å‚¨ä¸º $$[1, 4\times 9, H, W]$$ ï¼Œè¿™é‡Œç›¸å½“äºfeature mapsæ¯ä¸ªç‚¹éƒ½æœ‰ 9 ä¸ªanchorsï¼Œæ¯ä¸ªanchorsåˆéƒ½æœ‰ 4 ä¸ªç”¨äºå›å½’çš„å˜æ¢é‡ï¼š

$$
[d_x(A),d_y(A),d_w(A),d_h(A)]
$$

å›åˆ°å›¾10ï¼Œ`VGG`è¾“å‡º $$50*38*512$$ çš„ç‰¹å¾ï¼Œå¯¹åº”è®¾ç½® $$50*38*k$$ ä¸ªanchorsï¼Œè€Œ`RPN`è¾“å‡ºï¼š

1. å¤§å°ä¸º $$50*38*2k$$ çš„`positive/negative softmax`åˆ†ç±»ç‰¹å¾çŸ©é˜µï¼›
2. å¤§å°ä¸º $$50*38*4k$$ çš„regressionåæ ‡å›å½’ç‰¹å¾çŸ©é˜µã€‚

æ°å¥½æ»¡è¶³ `RPN` å®Œæˆ positive/negative åˆ†ç±» å’Œbounding box regression**ã€‚**

#### âœ **4.2.4ã€**Proposal Layer

**Proposal Layerè´Ÿè´£ç»¼åˆæ‰€æœ‰** $$[d_x(A),d_y(A),d_w(A),d_h(A)]$$ **å˜æ¢é‡å’Œpositive anchorsï¼Œè®¡ç®—å‡ºç²¾å‡†çš„proposalsï¼Œé€å…¥åç»­`RoI Pooling Layer`**ã€‚è¿˜æ˜¯å…ˆæ¥çœ‹çœ‹Proposal Layerçš„`caffe prototxt`å®šä¹‰ï¼š

```python
layer {
  name: 'proposal'
  type: 'Python'
  bottom: 'rpn_cls_prob_reshape'
  bottom: 'rpn_bbox_pred'
  bottom: 'im_info'
  top: 'rois'
  python_param {
    module: 'rpn.proposal_layer'
    layer: 'ProposalLayer'
    param_str: "'feat_stride': 16"
  }
}
```

Proposal Layeræœ‰3ä¸ªè¾“å…¥ï¼š`positive vs negative anchors`åˆ†ç±»å™¨ç»“æœ`rpn_cls_prob_reshape`ï¼Œå¯¹åº”çš„`bbox reg`çš„ $$[d_x(A),d_y(A),d_w(A),d_h(A)]$$ å˜æ¢é‡`rpn_bbox_pred`ï¼Œä»¥åŠ`im_info`ï¼›å¦å¤–è¿˜æœ‰å‚æ•°`feat_stride=16`ã€‚ é¦–å…ˆè§£é‡Š`im_info`ã€‚å¯¹äºä¸€å‰¯ä»»æ„å¤§å° $$P\times Q$$ å›¾åƒï¼Œä¼ å…¥Faster R-CNNå‰é¦–å…ˆreshapeåˆ°å›ºå®š $$M\times N$$ ï¼Œ $$\text{im_info}=[M, N, \text{scale_factor}]$$åˆ™ä¿å­˜äº†æ­¤æ¬¡ç¼©æ”¾çš„æ‰€æœ‰ä¿¡æ¯ã€‚ç„¶åç»è¿‡`Conv Layers`ï¼Œç»è¿‡4æ¬¡poolingå˜ä¸º $$W \times H=(M/16)\times (N/16)$$ å¤§å°ï¼Œå…¶ä¸­ `feature_stride=16` åˆ™ä¿å­˜äº†è¯¥ä¿¡æ¯ï¼Œç”¨äºè®¡ç®—anchoråç§»é‡ã€‚

Proposal Layer forwardï¼ˆ`caffe layer`çš„å‰ä¼ å‡½æ•°ï¼‰æŒ‰ç…§ä»¥ä¸‹é¡ºåºä¾æ¬¡å¤„ç†ï¼š

1. ç”Ÿæˆanchorsï¼Œåˆ©ç”¨ $$[d_x(A),d_y(A),d_w(A),d_h(A)]$$ å¯¹æ‰€æœ‰çš„anchorsåš`bbox regression`å›å½’ï¼ˆè¿™é‡Œçš„anchorsç”Ÿæˆå’Œè®­ç»ƒæ—¶å®Œå…¨ä¸€è‡´ï¼‰ã€‚
2. æŒ‰ç…§è¾“å…¥çš„`positive softmax scores`ç”±å¤§åˆ°å°æ’åºanchorsï¼Œæå–å‰`pre_nms_topN(e.g. 6000)`ä¸ªanchorsï¼Œå³æå–ä¿®æ­£ä½ç½®åçš„positive anchorsã€‚
3. clipè¶…å‡ºå›¾åƒè¾¹ç•Œçš„positive anchorsï¼ˆé˜²æ­¢åç»­`roi pooling`æ—¶proposalè¶…å‡ºå›¾åƒè¾¹ç•Œï¼‰ã€‚
4. å‰”é™¤éå¸¸å°ï¼ˆ`width<threshold or height<threshold`ï¼‰çš„positive anchorsã€‚
5. è¿›è¡Œ`nonmaximum suppression`ã€‚

ä¹‹åè¾“å‡º $$proposal=(x_1,y_1,x_2,y_2)$$ ï¼Œæ³¨æ„ï¼Œç”±äºåœ¨ç¬¬ä¸‰æ­¥ä¸­å°†anchorsæ˜ å°„å›åŸå›¾åˆ¤æ–­æ˜¯å¦è¶…å‡ºè¾¹ç•Œï¼Œæ‰€ä»¥è¿™é‡Œè¾“å‡ºçš„proposalæ˜¯å¯¹åº” $$M\times N$$ è¾“å…¥å›¾åƒå°ºåº¦çš„ï¼Œè¿™ç‚¹åœ¨åç»­ç½‘ç»œä¸­æœ‰ç”¨ã€‚å¦å¤–æˆ‘è®¤ä¸ºï¼Œä¸¥æ ¼æ„ä¹‰ä¸Šçš„æ£€æµ‹åº”è¯¥åˆ°æ­¤å°±ç»“æŸäº†ï¼Œåç»­éƒ¨åˆ†åº”è¯¥å±äºè¯†åˆ«äº†ã€‚

> `RPN`ç½‘ç»œç»“æ„æ€»ç»“èµ·æ¥å°±æ˜¯ï¼šç”Ÿæˆ`anchors -> softmax`åˆ†ç±»å™¨æå–`positvie anchors -> bbox reg`å›å½’`positive anchors -> Proposal Layer`ç”Ÿæˆ`proposals`

### ğŸ–‹ 4.3ã€[`RoI Pooling`](roi-pooling.md) 

### ğŸ–‹ 4.4ã€`RPN Multi-task loss`

æ•´ä¸ª`RPN`ç½‘ç»œä½¿ç”¨çš„Losså¦‚ä¸‹ï¼š

$$
L({p_i},{t_i}) = \frac{1}{N_{cls}}\sum_i L_{cls}(p_i,p_i^*) + \lambda \frac{1}{N_{reg}}\sum_i p_i^* L_{reg}(t_i,t_i^*)
$$

* $$p_i$$ è¡¨ç¤ºç¬¬ $$i$$ ä¸ªanchor é¢„æµ‹ä¸ºçœŸå®æ ‡ç­¾çš„æ¦‚ç‡ï¼›
* $$p_i^*$$ å½“ä¸ºæ­£æ ·æœ¬æ—¶ä¸º 1ï¼Œå½“ä¸ºè´Ÿæ ·æœ¬æ—¶ä¸º0ï¼ˆå³å½“ç¬¬iä¸ªanchorä¸GTé—´`IoU>0.7`ï¼Œè®¤ä¸ºæ˜¯è¯¥anchoræ˜¯positiveï¼Œ $$p_i^* = 1$$ ï¼›åä¹‹`IoU<0.3`æ—¶ï¼Œè®¤ä¸ºæ˜¯è¯¥anchoræ˜¯negativeï¼Œ $$p_i^* = 0$$ ï¼›è‡³äºé‚£äº›`0.3<IoU<0.7`çš„anchoråˆ™ä¸å‚ä¸è®­ç»ƒï¼‰ï¼›
* $$t_i$$ è¡¨ç¤ºé¢„æµ‹ç¬¬ $$i$$ ä¸ª anchorçš„è¾¹ç•Œæ¡†å›å½’å‚æ•°ï¼›
* $$t_i^*$$ è¡¨ç¤ºç¬¬ $$i$$ ä¸ª anchor å¯¹åº”çš„ `GT Box` çš„è¾¹ç•Œæ¡†å›å½’å‚æ•°ï¼›
* $$N_{cls}$$ è¡¨ç¤ºä¸€ä¸ª `mini-batch` ä¸­çš„æ‰€æœ‰æ ·æœ¬æ•°é‡256ï¼›
* $$N_{reg}$$ è¡¨ç¤º anchor ä½ç½®çš„ä¸ªæ•° ï¼ˆä¸æ˜¯anchor ä¸ªæ•°ï¼‰ çº¦2400.

å¯ä»¥åŒ–ç®€ï¼š $$\lambda$$ åœ¨è®ºæ–‡ä¸­å–å€¼ä¸º10ï¼Œåˆ™$$\frac{1}{N_{cls}} \approx \lambda\frac{1}{N_{reg}}$$ ï¼ŒPyTorchå®˜æ–¹å®ç°å°±æ˜¯è¿™ç§æ–¹æ³•ã€‚

#### 1ã€åˆ†ç±»æŸå¤±æœ‰ä¸¤ç§å®ç°æ–¹å¼

![](../../.gitbook/assets/image%20%2837%29.png)

![](../../.gitbook/assets/image%20%2828%29.png)

#### 2ã€è¾¹ç•Œæ¡†å›å½’æŸå¤±

![](../../.gitbook/assets/image%20%2835%29.png)

### ğŸ–‹ 4.5ã€Faster R-CNNè®­ç»ƒ

#### âœ 4.5.1ã€åˆ†éƒ¨è®­ç»ƒï¼ˆåŸè®ºæ–‡ï¼‰

åŸè®ºæ–‡ä¸­é‡‡ç”¨åˆ†åˆ«è®­ç»ƒ`RPN`ä»¥åŠFast R-CNNçš„æ–¹æ³•ï¼š

1. åˆ©ç”¨`ImageNet`é¢„è®­ç»ƒåˆ†ç±»æ¨¡å‹åˆå§‹åŒ–å‰ç½®å·ç§¯ç½‘ç»œå±‚å‚æ•°ï¼Œå¹¶ å¼€å§‹å•ç‹¬è®­ç»ƒ`RPN`ç½‘ç»œå‚æ•°ï¼› 
2. å›ºå®š`RPN`ç½‘ç»œç‹¬æœ‰çš„å·ç§¯å±‚ä»¥åŠå…¨è¿æ¥å±‚å‚æ•°ï¼Œå†åˆ©ç”¨ `ImageNet`é¢„è®­ç»ƒåˆ†ç±»æ¨¡å‹åˆå§‹åŒ–å‰ç½®å·ç§¯ç½‘ç»œå‚æ•°ï¼Œå¹¶åˆ©ç”¨`RPN` ç½‘ç»œç”Ÿæˆçš„ç›®æ ‡å»ºè®®æ¡†å»è®­ç»ƒFast R-CNNç½‘ç»œå‚æ•°ã€‚ 
3. å›ºå®šåˆ©ç”¨Fast R-CNNè®­ç»ƒå¥½çš„å‰ç½®å·ç§¯ç½‘ç»œå±‚å‚æ•°ï¼Œå»å¾®è°ƒ`RPN` ç½‘ç»œç‹¬æœ‰çš„å·ç§¯å±‚ä»¥åŠå…¨è¿æ¥å±‚å‚æ•°ã€‚ 
4. åŒæ ·ä¿æŒå›ºå®šå‰ç½®å·ç§¯ç½‘ç»œå±‚å‚æ•°ï¼Œå»å¾®è°ƒFast R-CNNç½‘ç»œçš„å…¨ è¿æ¥å±‚å‚æ•°ã€‚æœ€å`RPN`ç½‘ç»œä¸Fast R-CNNç½‘ç»œå…±äº«å‰ç½®å·ç§¯ç½‘ç»œå±‚ å‚æ•°ï¼Œæ„æˆä¸€ä¸ªç»Ÿä¸€ç½‘ç»œã€‚

#### âœ 4.5.2ã€è”åˆè®­ç»ƒ

ç›´æ¥é‡‡ç”¨`RPN Loss+ Fast R-CNN Loss`çš„è”åˆè®­ç»ƒæ–¹æ³•ã€‚

